<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Viewer</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="app">
        <input type="number" v-model:value="rootData.oid">
        <dstobj :data="rootData" root></dstobj>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        Vue.component('group', {
            props: {
                title: {
                    type: String,
                    required: true
                }
            },
            template: `
            <div class="group">
                <div class="group-title">
                    {{ title }}
                </div>
                <div class="group-content">
                    <slot></slot>
                </div>
            </div>
            `
        });

        Vue.component('dstobj', {
            props: {
                root: {
                    type: Boolean,
                    default: false
                },
                data: {
                    type: Object,
                    required: true
                }
            },
            data: function() {
                return {
                    expanded: false,
                    empty: -1,
                    innerData: {}
                }
            },
            template: `
            <div class="parent">
                <div class="title" :class="rootClass">
                    <span v-if="isObj" class="oid-container">
                        <span class="value oid" @click="toggle">{{ data.oid }}</span>
                    </span>
                    <span v-else class="value">
                        {{ data.value }}
                    </span>
                    <span v-if="!root" class="link">
                        {{ data.link }}
                        <i v-if="data.str"
                           class="description" :title="data.str">
                           ({{ shortStr }})
                         </i>
                     </span>
                </div>
                <div v-if="isExpanded" class="inner">
                    <group v-for="(objects, type) in innerData" v-if="objects.length" :title="type">
                        <dstobj
                            v-for="data in objects"
                            :data="data"
                        ></dstobj>
                    </group>
                    <span v-if="isLoading">загрузка...</span>
                    <span v-if="isEmpty" class="empty">пусто</span>
                </div>
            </div>
            `,
            methods: {
                toggle: function() {
                    if (!this.isObj) return;
                    this.expanded = !this.expanded;

                    if (this.expanded && this.empty === -1) {
                        console.log(this.oid);
                        axios.post("/api/", {"oid": this.data.oid})
                            .catch(error => console.log(error))
                            .then(response => {
                                const data = response.data;
                                console.log(data);
                                this.innerData = data;
                                this.empty = Object.keys(this.innerData).length === 0;
                            });
                    } else if (!this.isExpanded && this.root) {
                        this.innerData = {};
                        this.empty = -1;
                    }
                }
            },
            computed: {
                rootClass: function() {
                    return this.root ? "root" : "";
                },
                expandSymbol: function() {
                    return this.isExpanded ? "–" : "+";
                },
                isObj: function() {
                    return this.data.oid !== undefined;
                },
                isLoading: function() {
                    return this.isObj && this.empty === -1;
                },
                isEmpty: function() {
                    return this.isObj && this.empty === 1;
                },
                isExpanded: function() {
                    return this.isObj && this.expanded;
                },
                shortStr: function() {
                    return this.data.str.substr(0, 30) + (this.data.str.length > 30 ? "..." : "");
                }
            }
        });

        app = new Vue({
            el: '#app',
            data: {
                rootData: {
                    oid: 102068
                }
            }
        })
    </script>
</body>
</html>